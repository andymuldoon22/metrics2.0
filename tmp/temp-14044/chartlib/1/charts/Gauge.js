/* Copyright (c) Ericsson 2019 */

define("chartlib/charts/Gauge",["chartlib/charts/Chart","chartlib/base/d3"],function(e,t){"use strict";function a(e,a,i,r,n){var s=this.options.chart.radius.reference,u=this.getChartSize(),l=Math.min(u.width,u.height)/2,o=function(e){return e<=1?l*e:e},h=t.svg.arc().innerRadius(o(void 0!==i?i:s.inner)).outerRadius(o(void 0!==r?r:s.outer));return void 0!==n&&h.cornerRadius(o(n)),void 0!==e&&h.startAngle(e),void 0!==a&&h.endAngle(a),h}function i(e,t){var a=t.chart,i=a.min,r=a.origin,n=i<r?s*r:l,o=a.max-i;return n+(0!==e?2*u/o*e:0)}function r(e,t){return e.append("foreignObject").attr("class",t.class).append("xhtml:p").attr("class",t.labelClass).style(t.styles).text(t.text)}function n(e){var t=e.chart.labels.value;return t&&"function"==typeof t.format?t.format:function(e){return Math.round(parseFloat(e))}}var s=2*Math.PI,u=2.2,l=s-u,o=s+u;return e.extend({defaults:{theme:{line:{reference:{fill:"#efefef"},valueLine:{fill:"#00a9d4"}},titleText:{styles:{margin:"0",color:"#888888","font-weight":"normal","word-wrap":"break-word","text-align":"center"},heightTransform:30},centerText:{styles:{fill:"#333333","font-weight":"normal","font-family":"EricssonCapitalTT"}},labelText:{styles:{fill:"#58585b","font-weight":"normal"}}},chart:{min:0,origin:0,max:100,labels:{min:"0",max:"100"},areas:[],radius:{reference:{inner:.85,outer:1},valueLine:{inner:.8,outer:.9}}},legend:!1,grid:!1},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data={},this.value=0,this.gaugeWrapper=[],this.arcHelpers={}},redraw:function(){this.createWrapper(),this.update(this.options.data)},createWrapper:function(){0===this.gaugeWrapper.length&&(this.gaugeWrapper=this.svg.append("g").attr("id","gaugeWrapper-"+this.id))},positionGauge:function(){var e=this.chartSize,t=e.margins,a=t.left+e.width/2,i=t.top+e.height/2;this.gaugeWrapper.attr("transform","translate("+a+","+i+")")},onUpdate:function(e){this.options.data=e;var t=this.chartSize,a=this.getSize(),i=Math.min(a.width,a.height);this.data=e,this.newValue=e.value;var r=this.options.chart.margin;t.width=i-r.left-r.right,t.height=i-r.top-r.bottom,t.margins={left:r.left,top:r.top},this.positionGauge(),this.createReferenceLine(),this.createAreas(),this.updateValueLine(),this.updateMiddleText(),this.updateTitleText(),this.updateMinMaxText(),this.value=this.newValue},createReferenceLine:function(){void 0===this.gaugeRefLine&&(this.gaugeRefLine=this.gaugeWrapper.append("g").attr("class","gaugeRefLineGroup").append("path").attr("class","gaugeRefLine").attr("fill",this.options.theme.line.reference.fill)),this.gaugeRefLine.attr("d",a.call(this,l,o))},createAreas:function(){var e=this.options,t=e.chart;void 0===this.gaugeAreasGroup&&(this.gaugeAreasGroup=this.gaugeWrapper.append("g").attr("class","gaugeAreasGroup")),t.areas.reduce(function(e,a,i){return void 0===e?a:(e.fromValue=void 0!==e.fromValue?e.fromValue:t.min,e.toValue=void 0!==e.toValue?e.toValue:a.fromValue,a.fromValue=void 0!==a.fromValue?a.fromValue:e.toValue,a)},void 0);var r=e.theme.line.reference.fill,n=this.gaugeAreasGroup.selectAll("g.gaugeAreaGroup").data(t.areas),s=a.call(this),u={chart:t};this.areas=t.areas,n.enter().append("g").attr("class","gaugeAreaGroup").append("path").attr("fill",function(e){return e.fill||r}),n.exit().remove(),n.selectAll("g.gaugeAreaGroup path").attr("d",function(e){return s.startAngle(i(e.fromValue||t.min,u)).endAngle(i(e.toValue||t.max,u)),s()})},updateValueLine:function(){var e=this.options,r=e.chart,n=e.animation,s=r.radius.valueLine,u={chart:r},l=function(e){return i(e.previous,u)},o=function(e){return Math.min(r.max,Math.max(r.min,e))},h=o(this.value),g=o(this.newValue),p=a.call(this,i(r.origin,u),l,s.inner,s.outer,s.outer-s.inner),f=function(e){var a=t.interpolate(e.previous,g);return function(t){return e.previous=a(t),p(e)}},c=e.theme.line.valueLine.fill,d=c,x=this.areas;void 0===this.gaugeValueLine&&(this.gaugeValueLine=this.gaugeWrapper.append("g").attr("class","gaugeValueLineGroup").append("path").datum({previous:h}).attr("class","gaugeValueLine").attr("fill",c)),x.some(function(e,t){return g>=e.fromValue&&(void 0===e.toValue||g<e.toValue)?(d=e.lineFill||c,void 0!==x[t+1]&&x[t+1].fromValue>g):void(d=c)}),h===g?this.gaugeValueLine.attr("d",p):this.gaugeValueLine.transition().delay(n.transitionDelay).ease(n.easing).duration(n.transitionDuration).attrTween("d",f).attr("fill",d)},updateMiddleText:function(){var e=this.options,a=e.theme.centerText.styles;void 0===this.gaugeCenterText&&(this.gaugeCenterText=this.gaugeWrapper.append("g").attr("class","gaugeCenterTextGroup").append("text").attr("class","gaugeCenterText").attr("text-anchor","middle").style(a));var i=e.animation,r=this.getChartSize(),s=a["font-size"],u=void 0!==s?parseInt(s):r.height/4.5,l=this.newValue,o=n(e);this.gaugeCenterText.style({"font-size":u+"px"}),this.gaugeCenterText.transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).tween("text",function(e){this.textValue=void 0!==this.textValue?this.textValue:this.textContent;var a=t.interpolate(this.textValue,l);return function(e){var t=a(e);this.textValue=t,this.textContent=o(t)}})},updateTitleText:function(){var e=this.options,t=e.theme.titleText.styles;if(void 0===this.gaugeTitleText){var a=this.gaugeWrapper.append("g").attr("class","gaugeTitleTextGroup");r(a,{class:"gaugeTitleText",labelClass:"gaugeTitleTextLabel",styles:t,text:e.chart.labels.title}),this.gaugeTitleText=a.select(".gaugeTitleText").attr("text-anchor","middle")}var i=this.getChartSize(),n=t["font-size"],s=void 0!==n?parseInt(n):i.height/10,u=i.width/2;this.gaugeTitleText.attr("transform","translate("+-u/2+", "+i.height/10+")").attr("width",Math.max(0,i.width/2)).attr("height",Math.max(0,i.height/3)),this.gaugeTitleText.select(".gaugeTitleTextLabel").style({"line-height":s+"px","font-size":s+"px"})},updateMinMaxText:function(){var e=this.options,t=e.theme.labelText.styles,a=this.getChartSize(),i=a.width/2,r=a.height/2*.8,n=t["font-size"],s=void 0!==n?parseInt(n):a.height/15;if(void 0===this.gaugeRefLineTextGroup){this.gaugeRefLineTextGroup=this.gaugeWrapper.append("g").attr("class","gaugeRefLineTextGroup");var u=e.chart.labels;this.gaugeRefLineTextGroup.append("text").attr("class","gaugeRefLineText-min").style(t).text(u.min),this.gaugeRefLineTextGroup.append("text").attr("class","gaugeRefLineText-max").attr("text-anchor","end").attr("startOffset","100%").style(t).text(u.max)}this.gaugeRefLineTextGroup.attr("transform","translate(0,"+r+")"),this.gaugeRefLineTextGroup.select(".gaugeRefLineText-min").attr("x",-i).style({"font-size":s+"px"}),this.gaugeRefLineTextGroup.select(".gaugeRefLineText-max").style({"font-size":s+"px"}).attr("x",i)},getChartSize:function(){return this.chartSize}})});