/* Copyright (c) Ericsson 2019 */

define("chartlib/charts/InfographicPie",["chartlib/base/d3","chartlib/charts/Chart"],function(t,e){"use strict";return e.extend({defaults:{theme:{title:{fontSize:38},subTitle:{fontSize:20},plotOptions:{infographicPie:{number:{unit:"%",fontWeight:"bold",fontSize:68,fontFamily:"Ericsson Capital, Arial",fill:"#58585b"},label:{fontWeight:"bold",fontSize:14,fill:"#58585b"},stroke:{color:"#ffffff",width:1}}}},plotOptions:{infographicPie:{radius:.7,innerRadius:.6}},grid:!1},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data=[],this.infographicPieWrapper=[],this.infographicLabelWrapper=[],this.radius=0,this.innerRadius=0,this.isSingleValue=!0,this.arcHelpers={}},redraw:function(){this.createWrapper(),this.update(this.options.data)},createWrapper:function(){0===this.infographicPieWrapper.length&&(this.infographicPieWrapper=this.svg.append("g").attr("id","infographicPieWrapper-"+this.id),this.infographicLabelWrapper=this.svg.append("g").attr("id","infographicLabelWrapper-"+this.id))},onUpdate:function(t){this.options.data=t,this.data=this.makeNominators(t);var e=this.chartSize,i=this.data,a=this.options,n=this.infographicPieWrapper,r=this.infographicLabelWrapper,s=this.arcHelpers,l=this.getSize(),o=a.chart.margin;e.width=l.width-o.left-o.right,e.height=l.height-o.top-o.bottom,e.margins={left:o.left,top:o.top},e=this.changeSizeForTitle(e),this.figureOutRadius();var h=this.figureOutInnerTextRestriction(),u=this.figureOutOuterTextRestriction();this.createArcHelpers(),this.positionPie();var c=n.selectAll(".arc").data(s.pie(i.nominators)),f=this.isSingleValue===!0?[i.nominators[0]]:i.nominators,p=r.selectAll(".label").data(f);p.enter().append("g").attr("class","label");var d=p.selectAll(".labelNumber").data(function(t){return[t]}),g=p.selectAll(".labelText").data(function(t){return[t]});if(this.updatePieArcs(c),this.updateLabelNumber(d),this.createNewPieArcs(c),this.createNewLabelNumber(d,h,u),this.createNewLabelText(g,h,u),this.positionLabelGroup(p,h,u),a.theme.plotOptions.infographicPie.stroke!==!1){var b=n.selectAll(".arcLine").data(s.pie(i.nominators));this.updateArcLine(b),this.createArcLine(b)}},makeNominators:function(t){if(1===t.length){for(;t[0].value>100;)t[0].value/=10;return{nominators:[{label:t[0].label,value:t[0].value},{label:"",value:100-t[0].value}]}}this.isSingleValue=!1;var e=t[0].value+t[1].value;return{nominators:[{label:t[0].label,value:t[0].value/e*100},{label:t[1].label,value:t[1].value/e*100}]}},figureOutRadius:function(){var t=this.chartSize,e=t.margins,i=(t.width-e.left)*(this.isSingleValue===!0?1:.4),a=t.height-e.top,n=Math.min(i,a);this.radius=n/1.5;var r=this.options.plotOptions.infographicPie;this.radius*=r.radius,this.innerRadius=this.radius*r.innerRadius},figureOutInnerTextRestriction:function(){var t=2*Math.sqrt(Math.pow(this.innerRadius,2)/2),e=this.chartSize,i=e.margins;return{left:i.left+e.width/2-t/2,top:i.top+e.height/2-t/2,width:t,height:t}},figureOutOuterTextRestriction:function(){var t=this.chartSize,e=this.radius,i=t.margins;return{left:{x:i.left,y:i.top+t.height/2-e,width:t.width/2-e-e/5,height:2*e},right:{x:i.left+t.width/2+e+e/5,y:i.top+t.height/2-e,width:t.width/2-e-e/5,height:2*e}}},createArcHelpers:function(){this.arcHelpers.arc=t.svg.arc().outerRadius(this.radius).innerRadius(this.innerRadius),this.arcHelpers.pie=t.layout.pie().sort(null).value(function(t){return t.value})},positionPie:function(){var t=this.chartSize,e=t.margins,i=e.left+t.width/2,a=e.top+t.height/2;this.infographicPieWrapper.attr("transform","translate("+i+","+a+")")},updatePieArcs:function(t){var e=this.options.animation,i=this;t.attr("class","update arc clickable hoverable datapoint").each(function(t){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0)}).transition().duration(e.transitionDuration).delay(e.transitionDelay).ease(e.easing).attrTween("d",function(t){return i.arcTween(t,this,i)}).attr("fill",function(t){return i.colorScale(t.data.label,t)})},updateLabelNumber:function(e){var i=this.options,a=this,n=i.animation,r=i.theme.plotOptions.infographicPie.number.unit;e.attr("class","update labelNumber").transition().duration(n.transitionDuration).delay(n.transitionDelay).ease(n.easing).tween("text",function(e){var i=t.interpolate(this.textContent.replace(r,"").replace(",","."),a.roundToDecimals(e.value).replace(",","."));return this.textContent=i(0),function(t){this.textContent=a.roundToDecimals(i(t))+r}})},createNewPieArcs:function(t){var e=this,i=this.options.animation;t.enter().append("path").attr("class","enter arc clickable hoverable datapoint").each(function(t){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0),this._current=t}).attr("d",this.arcHelpers.arc).attr("fill",function(t){return e.colorScale(t.data.label,t)}).transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attrTween("d",function(t){return e.arcTween(t,this,e)})},createNewLabelNumber:function(t,e,i){var a=this.options,n=a.theme.plotOptions.infographicPie.number,r=this,s=this.isSingleValue;t.enter().append("text").attr("class","enter labelNumber").attr("font-family",n.fontFamily).attr("fill",n.fill).attr("dy","0.7em").text(function(t){return r.roundToDecimals(t.value)+n.unit}),t.attr("font-size",function(){var t,i=a.chart,l=0===i.decimals?"100":"00",o=n.fontSize;l+=i.decimals>0?i.decimalSeparator:"";for(var h=0;h<i.decimals;h++)l+="0";for(l+=n.unit,t=r.measureTextFieldSize(l,o,n.fontFamily);t.width>e.width&&(o-=2,!(o<10));)t=r.measureTextFieldSize(l,o,n.fontFamily);return s===!0?o:2.5*o}).attr("text-anchor",function(t,e,i){return s===!0?"middle":0!==i?"end":"start"}).attr("x",function(t,a,n){return s===!0?e.left+e.width/2:0!==n?i.left.x+i.left.width:i.right.x})},createNewLabelText:function(e,i,a){var n=this.options.theme.plotOptions.infographicPie.label,r=this.wrapTextField.bind(this),s=this.isSingleValue;e.enter().append("text").attr("class","enter labelText").attr("font-family",n.fontFamily).attr("font-size",n.fontSize).attr("fill",n.fill).attr("text-anchor",function(t,e,i){return s?"middle":0!==i?"end":"start"}),e.attr("x",function(t,e,n){return s?i.left+i.width/2:0!==n?a.left.x+a.left.width:a.right.x}).attr("y",function(e,i,a){var n=10;return s===!0&&(n=5),n+.72*t.select(this).attr("font-size")+.72*t.select(this.parentNode).select(".labelNumber").attr("font-size")}).each(function(e,n,l){var o=t.select(this),h=o.selectAll("tspan"),u=0!==l?a.left.x+a.left.width:a.right.x,c=a.right.width,f=10,p=1.1;s&&(u=i.left+i.width/2,c=i.width,f=3),h.empty()||h.remove(),s&&(i.width<50||i.height<50)||r(o,e.label,u,c,p,f)})},positionLabelGroup:function(e,i,a){var n=this.isSingleValue;e.attr("transform",function(e){var r=0,s=0;if(n)s=i.top+(i.height-.85*this.getBBox().height)/2;else{var l=.7*t.select(this).select(".labelNumber").node().getBBox().height;s=a.right.y,s+=(a.right.height-l)/2}return"translate("+r+","+s+")"})},arcTween:function(e,i,a){isNaN(i._current.endAngle)&&(i._current.endAngle=0,i._current.startAngle=0,e.endAngle=0,e.startAngle=0);var n=t.interpolate(i._current,e);return i._current=n(0),function(t){return a.arcHelpers.arc(n(t))}},updateArcLine:function(t){var e=this.options.animation,i=this;t.each(function(t){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0)}).transition().duration(e.transitionDuration).delay(e.transitionDelay).ease(e.easing).attrTween("d",function(t){return i.lineTween(t,this,i)})},createArcLine:function(t){var e,i,a=this.options,n=this,r=a.animation,s=a.theme.plotOptions.infographicPie.stroke;s===!0?(e="white",i=1):(e=s.color,i=s.width),t.enter().append("path").style("stroke-width",i).attr("class","arcLine").attr("stroke",e).each(function(t){this._current=t}).attr("d",function(t){return n.arcLine(t,n)}).transition().duration(r.transitionDuration).delay(r.transitionDelay).ease(r.easing).attrTween("d",function(t){return n.lineTween(t,this,n)})},arcLine:function(t,e){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0);var i=Math.sin(t.startAngle)*e.innerRadius,a=Math.cos(t.startAngle)*e.innerRadius*-1,n=Math.sin(t.startAngle)*e.radius,r=Math.cos(t.startAngle)*e.radius*-1,s=" M"+i+","+a+" L"+i+","+a+" L"+n+","+r;return s},lineTween:function(e,i,a){isNaN(i._current.endAngle)&&(i._current.endAngle=0,i._current.startAngle=0,e.endAngle=0,e.startAngle=0);var n=t.interpolate(i._current,e);return i._current=n(0),function(t){return a.arcLine(n(t),a)}},getTooltipContent:function(t){var e=this.options.tooltip.format,i="function"==typeof e?e:function(t){var e=t.label||"";return e.length>15&&(e=e.substr(0,15)+"..."),(t.label?e+" : ":"")+t.value.toString()};return i.call(this,this.cleanEventData(t))},cleanEventData:function(t){var e={};return Object.defineProperties(e,{label:{value:t.data.label},value:{value:t.data.value}}),e}})});