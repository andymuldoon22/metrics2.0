/* Copyright (c) Ericsson 2019 */

define("chartlib/charts/MultiFigure",["chartlib/base/d3","chartlib/charts/Chart"],function(t,a){"use strict";return a.extend({defaults:{theme:{title:{fontSize:38},subTitle:{fontSize:20},plotOptions:{pictorial:{number:{fontWeight:"normal",fontFamily:"Ericsson Capital, Arial",fontSize:"100",fill:"#58585b"},descriptive:{fontFamily:"Arial",fontWeight:"normal",fontSize:13,fill:"#58585b"}}}},plotOptions:{pictorial:{descriptive:!1}},chart:{margin:"useSpecialMargins"},grid:!1},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data=[],this.multiFigureWrapper=[],this.labelWrapper=[],this.numberWrapper=[],this.figureWrapper=[],this.nominatorClipPath=[],this.denominatorClipPath=[],this.table=null,this.figureSize=null,this.useSpecialMargins=!1,"useSpecialMargins"===this.options.chart.margin&&(this.useSpecialMargins=!0),this.FIGURE_GAP=.15,this.UNSELECTED_OPACITY=.4,this.figureCount=null,this.previousFigureCount={filledFigures:0,nonfilledFigures:0,totalFigures:0},this.figureHeight=0,this.previousTable=null,this.scaleChanged=!1,this.isZeroValues=!1,this.wasZeroValues=!1,this.hasFraction=0},redraw:function(){if(this.createWrapper(),this.createFractionClipPaths(),this.useSpecialMargins===!0){var t=this.getSize();t=.0476*t.width,this.options.chart.margin={top:t,bottom:t,left:0,right:0}}this.update(this.options.data)},createWrapper:function(){0===this.multiFigureWrapper.length&&(this.multiFigureWrapper=this.svg.append("g").attr("id","singleFigureWrapper-"+this.id),this.numberWrapper=this.multiFigureWrapper.append("g").attr("id","numberWrapper-"+this.id),this.labelWrapper=this.multiFigureWrapper.append("g").attr("id","labelWrapper-"+this.id),this.figureWrapper=this.multiFigureWrapper.append("g").attr("id","figureWrapper-"+this.id))},createFractionClipPaths:function(){0===this.nominatorClipPath.length&&(this.nominatorClipPath=this.defs.append("clipPath"),this.nominatorClipPath.attr("id","nominatorClipPath-"+this.id).append("rect"),this.denominatorClipPath=this.defs.append("clipPath"),this.denominatorClipPath.attr("id","denominatorClipPath-"+this.id).append("rect"))},onUpdate:function(t){this.options.data=t,this.data=t,this.data[0].value=this.roundToDecimals(this.data[0].value),this.data[1].value=this.roundToDecimals(this.data[1].value),this.hasFraction=this.data[0].value%1,this.figureCount={filledFigures:parseFloat(this.data[0].value),nonfilledFigures:parseFloat(this.data[1].value)-parseFloat(this.data[0].value),totalFigures:parseFloat(this.data[1].value)},0===parseFloat(this.figureCount.totalFigures)&&(this.isZeroValues=!0),this.firstRun===!1&&0===parseFloat(this.previousFigureCount.totalFigures)&&(this.wasZeroValues=!0);var a=this.chartSize,i=this.data,e=this.options,r=this.getSize(),s=e.chart,n=s.margin;a.width=r.width-n.left-n.right,a.height=r.height-n.top-n.bottom,a.margins={left:n.left,top:n.top},a=this.changeSizeForTitle(a),this.positionWrapper(),this.setAreaSizes();var l=e.plotOptions.pictorial.descriptive;if(l!==!1){var o=this.labelWrapper.selectAll(".label").data([{value:0,label:l.text}]);this.updateLabelText(o),this.createLabelText(o)}var h,u=s.scale.y;if(u){var p=Math.max(i[0].value,i[1].value);p=Math.max(p,u);var c=s.decimals;h=this.roundToDecimals(p,c,!0)+"/"+this.roundToDecimals(p,c,!0)}else h=this.roundToDecimals(i[0].value)+"/"+this.roundToDecimals(i[1].value);var g=e.theme.plotOptions.pictorial.number;this.numberSize=this.measureTextFieldSize(h,g.fontSize,g.fontFamily);var d=this.numberWrapper.selectAll(".label").data([i]);this.updateNumber(d),this.createNumber(d),this.moveAndScaleNumber(),this.moveLabelText(),this.figureSize=this.measureFigurePath(e.path),this.table=this.createTable(),this.firstRun===!1&&(this.scaleChanged=this.table.cols!==this.previousTable.cols);var f=this.makeSelectionData(),m=this.figureWrapper.selectAll(".figure").data(f),v=f.length;this.previousFigureCount.totalFigures>this.figureCount.totalFigures&&(v=this.previousFigureCount.totalFigures);var b=e.animation.transitionDuration/v;this.createFigures(m),this.updateFigures(m,v,b),this.removeFigures(m,v,b),this.moveFigures(),this.previousFigureCount={filledFigures:parseFloat(this.data[0].value),nonfilledFigures:parseFloat(this.data[1].value)-parseFloat(this.data[0].value),totalFigures:parseFloat(this.data[1].value)},this.previousTable=this.table,this.wasZeroValues=!1,this.isZeroValues=!1},createFigures:function(t){var a=this.firstRun,i=this.data.map(function(t){return{label:t.label,value:parseFloat(t.value)}}),e=this.colorScale,r=this.options,s=r.theme.colors;t.enter().append("g").attr("class","enter figure").attr("fill",function(){return Array.isArray(s)?s[0]:e(i)}).attr("opacity",function(){return a.firstRun===!0?1:0}).append("path").attr("d",r.path)},getFigureDuration:function(t,a,i,e,r,s){if(a.firstRun===!0)return 0;var n=0;return void 0!==t.previousValue?(1===t.previousValue&&0===i.value&&(n=(r-e)*s),1===t.previousValue&&1===i.value&&(n=(r-e)*s),0===t.previousValue&&0===i.value&&(n=(r-e)*s),0===t.previousValue&&1===i.value&&(n=e*s)):n=e*s,n},updateFigures:function(a,i,e){var r=this,s=this.data.map(function(t){return{label:t.label,value:parseFloat(t.value)}}),n=this.colorScale,l=this.options,o=l.animation,h=l.theme.colors;if(r.scaleChanged===!0&&r.wasZeroValues===!1?a.transition().duration(0).delay(o.transitionDuration/2).attr("transform",function(t,a){return r.transformFigure(a,this,r)}).attr("opacity",function(t){return this.previousValue=t.value,1===t.value?1:r.UNSELECTED_OPACITY}):a.attr("transform",function(t,a){return r.transformFigure(a,this,r)}).transition().duration(function(t,a){return r.getFigureDuration(this,r,t,a,i,e)}).delay(o.transitionDelay).ease(o.easing).attr("opacity",function(t){return this.previousValue=t.value,1===t.value?1:r.UNSELECTED_OPACITY}),a.attr("fill",function(){return Array.isArray(h)?h[0]:n(s)}),0!==r.hasFraction){var u,p,c=Math.ceil(r.data[0].value)-1;a.each(function(a,s){if(u=t.select(this),s===c){1===u.selectAll("path")[0].length&&(u.select("path").attr("clip-path","url(#nominatorClipPath-"+r.id+")").attr("class","nominatorPath"),p=r.getFigureDuration(this,r,a,s,i,e),u.append("path").attr("clip-path","url(#denominatorClipPath-"+r.id+")").attr("class","denominatorPath").attr("d",l.path).attr("opacity",1).transition().duration(p).delay(o.transitionDelay).ease(o.easing).attr("opacity",r.UNSELECTED_OPACITY));var n=r.figureSize;r.nominatorClipPath.selectAll("rect").attr("y",0).attr("x",0).attr("width",Math.max(0,n.width*r.hasFraction)).attr("height",Math.max(0,n.height)),r.denominatorClipPath.selectAll("rect").attr("y",0).attr("x",n.width*r.hasFraction).attr("width",Math.max(0,n.width*(1-r.hasFraction))).attr("height",Math.max(0,n.height))}else 2===u.selectAll("path")[0].length&&(p=r.getFigureDuration(this,r,a,s,i,e),u.selectAll(".denominatorPath").transition().duration(p).delay(o.transitionDelay).ease(o.easing).attr("opacity",1).each("end",function(){t.select(t.select(this).node().parentNode).select(".nominatorPath").attr("clip-path",null),t.select(this).remove()}))})}},removeFigures:function(t,a,i){var e=this.options.animation,r=this,s=r.scaleChanged===!0?e.transitionDuration/2:0;t.exit().transition().duration(function(t,s){if(r.scaleChanged===!0)return 0;var n=(a-s)*i;return e.transitionDelay+n}).delay(e.transitionDelay+s).ease(e.easing).attr("opacity",0).remove()},transformFigure:function(t,a,i){var e=i.getPositionInTable(i.table,t),r=i.availableSpace.figure/(i.table.cols-i.FIGURE_GAP),s=r*i.FIGURE_GAP;r-=s;var n=r/i.figureSize.width,l=i.figureSize.height*n;return i.figureHeight=l+s,"matrix("+n+" 0 0 "+n+" "+e.col*(r+s)+" "+e.row*(l+s)+")"},positionWrapper:function(){var t=this.chartSize.margins;this.multiFigureWrapper.attr("transform","translate("+t.left+", "+t.top+")")},measureFigurePath:function(t){var a=this.svg.append("path").attr("d",t),i=a.node().getBBox();return a.remove(),i},setAreaSizes:function(){this.availableSpace={marginleft:.0476,figure:.4286,gap:.0476,label:.4286,number:.3815,marginright:.0476};var t=this.chartSize.width;this.availableSpace.marginleft=this.availableSpace.marginleft*t,this.availableSpace.figure=this.availableSpace.figure*t,this.availableSpace.gap=this.availableSpace.gap*t,this.availableSpace.number=this.availableSpace.number*t,this.availableSpace.label=this.availableSpace.label*t,this.availableSpace.marginright=this.availableSpace.marginright*t},makeSelectionData:function(){for(var t=parseFloat(this.data[1].value),a=[],i=this.data[0].value,e=0;e<t;e++)a.push({label:e,value:e<i?1:0});return a},createTable:function(){for(var t,a,i,e,r,s=[5,10,15,30,40],n=parseFloat(this.data[1].value),l=this.getAssumedColumnScale(n),o={cols:1,rows:1},h=l;h<s.length;h++)if(t=s[h],a=Math.ceil(n/t),i=this.availableSpace.figure/t,e=i/this.figureSize.width,r={width:this.figureSize.width*e,height:this.figureSize.height*e},r.height*a<=1.2*this.chartSize.height){o={cols:t,rows:a};break}return o},getAssumedColumnScale:function(t){return t<=10?0:t<=100?1:t<=160?2:t<=300?3:t<=1e4?4:void 0},getPositionInTable:function(t,a){return{col:a%t.cols,row:Math.floor(a/t.cols)}},updateLabelText:function(t){var a=this,i=this.options.animation;t.attr("class","update label").text("").each(function(t){a.wrapLabelText(t,this,a)}).transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attr("opacity",1)},createLabelText:function(t){var a=this,i=this.options.theme.plotOptions.pictorial.descriptive;t.enter().append("text").attr("class","enter label").attr("font-weight",i.fontWeight).attr("font-size",i.fontSize).attr("font-family",i.fontFamily).attr("fill",i.fill).attr("dy",".71em").attr("opacity",function(){return a.isZeroValues===!0?0:1}).each(function(t){a.wrapLabelText(t,this,a)})},wrapLabelText:function(a,i,e){var r=e.availableSpace.marginleft+e.availableSpace.figure+e.availableSpace.gap,s=e.availableSpace.label,n="1.2";e.wrapTextField(t.select(i),a.label,r,s,n)},updateNumber:function(a){var i=this.options.animation,e=this;a.attr("class","update label").transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attr("opacity",1).tween("text",function(a){var i=t.interpolate(this.textContent.split("/")[0].replace(",","."),e.roundToDecimals(a[0].value).replace(",",".")),r=t.interpolate(this.textContent.split("/")[1].replace(",","."),e.roundToDecimals(a[1].value).replace(",","."));return function(t){var a=e.roundToDecimals(i(t)),s=e.roundToDecimals(r(t));this.textContent=a+"/"+s}})},createNumber:function(t){var a=this.options.theme.plotOptions.pictorial.number,i=this;t.enter().append("text").attr("class","enter label").attr("font-family",a.fontFamily).attr("font-size",a.fontSize).attr("fill",a.fill).attr("opacity",function(){return i.isZeroValues===!0?0:1}).attr("dy","0.9em").text(function(t){return i.roundToDecimals(t[0].value)+"/"+i.roundToDecimals(t[1].value)})},moveAndScaleNumber:function(){var t=this.availableSpace,a=this.chartSize.height,i=this.numberSize,e=t.number/i.width,r=a/i.height,s=Math.min(e,r),n=i.width*s;n=t.number-n+t.marginleft+t.gap+t.figure;var l=i.height*s;this.options.plotOptions.pictorial.descriptive!==!1&&(l+=this.labelWrapper.node().getBBox().height+10),l=(a-l)/2,this.numberWrapper.attr("transform","matrix("+s+", 0, 0, "+s+", "+n+", "+l+")"),this.numberWrapScale=s},moveLabelText:function(){var t=this.options.plotOptions.pictorial.descriptive;if(t!==!1){var a=this.numberSize.height*this.numberWrapScale;t!==!1&&(a+=this.labelWrapper.node().getBBox().height+10),a=(this.chartSize.height-a)/2,a+=this.numberSize.height*this.numberWrapScale,a-=this.numberSize.height*this.numberWrapScale*.2,a+=10,this.labelWrapper.attr("transform","translate(0,"+a+")")}},moveFigures:function(){var t=this.options.animation,a=this.availableSpace.figure-this.figureWrapper.node().getBBox().width+this.availableSpace.marginleft,i=(this.chartSize.height-this.figureHeight*this.table.rows)/2,e=this;this.wasZeroValues===!0?this.figureWrapper.attr("transform","translate("+a+","+i+")").attr("opacity",0).transition().duration(t.transitionDuration).delay(t.transitionDelay).attr("opacity",1):this.scaleChanged===!0?(this.figureWrapper.attr("opacity",1).transition().duration(t.transitionDuration/2-100).attr("opacity",0),this.figureWrapper.transition().duration(0).delay(t.transitionDuration/2).attr("transform",function(){var t=e.availableSpace.figure-e.figureWrapper.node().getBBox().width+e.availableSpace.marginleft,a=(e.chartSize.height-e.figureHeight*e.table.rows)/2;return"translate("+t+","+a+")"}),this.figureWrapper.transition().duration(t.transitionDuration/2).delay(t.transitionDuration/2+100).attr("opacity",1)):this.firstRun===!0||this.figureCount.totalFigures===this.previousFigureCount.totalFigures?this.figureWrapper.attr("transform","translate("+a+","+i+")"):this.figureWrapper.transition().duration(t.transitionDuration/2).delay(t.transitionDelay).ease(t.easing).attr("transform","translate("+a+","+i+")")}})});