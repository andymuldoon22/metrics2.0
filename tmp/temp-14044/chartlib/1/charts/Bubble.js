/* Copyright (c) Ericsson 2019 */

define("chartlib/charts/Bubble",["chartlib/base/d3","chartlib/charts/Chart"],function(t,e){"use strict";function a(t){if(this.dataIsGrouped===!0){var e=this.findLabelInGroup(t.label);return this.colorScale(e.label,t)}return this.colorScale(t.label,t)}function i(t){var e,a,i=[],n={};for(e=0;e<t.length;e++)a=t[e].value[3],a&&(void 0===n[a]&&(n[a]={label:a,id:i.length,data:[],visible:t[e].visible},i.push(n[a])),n[a].data.push(t[e]));return 0===Object.keys(n).length?t:(this.dataIsGrouped=!0,i)}return e.extend({defaults:{theme:{plotOptions:{bubble:{border:!1}}},plotOptions:{bubble:{minSize:0,maxSize:"40%",scalePadding:{x:!0,y:!0}},scaleType:{x:"linear",y:"linear"}}},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data=[],this.dataByGroup=[],this.scaleValues={xMax:0,xMin:0,yMax:0,yMin:0,zMin:0,zMax:0,bubbleMinRad:0,bubbleMaxRad:0},this.bubbleWrapperClipPath=[],this.bubbleWrapper=[],this.dataIsGrouped=!1},redraw:function(){this.createWrapper(),this.update(this.options.data)},createWrapper:function(){0===this.bubbleWrapper.length&&(this.bubbleWrapperClipPath=this.defs.append("clipPath"),this.bubbleWrapperClipPath.attr("id","bubbleWrapperClipPath-"+this.id).append("rect"),this.bubbleWrapper=this.svg.append("g").attr("id","bubbleWrapper-"+this.id),this.bubbleWrapper.attr("clip-path","url(#bubbleWrapperClipPath-"+this.id+")"))},onUpdate:function(t){this.options.data=t,this.data=this.addIDsToData(t);var e=this.data,a=this.options,n=this.chartSize,r=this.bubbleWrapper,s=this.bubbleWrapperClipPath;this.dataByGroup=i.call(this,e),e=this.data.filter(function(t){return t.visible!==!1});var l=this.getSize(),h=a.chart.margin;n.width=l.width-h.left-h.right,n.height=l.height-h.top-h.bottom,n.margins={left:h.left,top:h.top},n=this.changeSizeForTitle(n),n=this.changeSizeForLegend(n,this.dataByGroup),n=this.changeSizeForGrid(n,e);var b={left:0,right:0};a.grid!==!1&&(b=this.grid.getOptions().gridPadding);var o=n.margins;r.attr("transform","translate("+(o.left+b.left)+","+o.top+")"),s.selectAll("rect").attr("y",0).attr("x",0).attr("width",Math.max(0,n.width-(b.left+b.right))).attr("height",Math.max(0,n.height)),this.setRangesAndSizes(),this.setScaleHelpers(),this.bubbleSelection=r.selectAll(".bubble").data(e),this.updateExistingElements(this.bubbleSelection),this.createElements(this.bubbleSelection);var u=a.theme.plotOptions.bubble.border;u?this.bubbleSelection.attr("stroke",u.color).attr("stroke-width",u.width):this.bubbleSelection.attr("opacity","0.85"),a.grid!==!1&&this.grid.update(e,this.chartSize,this.scaleHelper),a.legend!==!1&&this.legend.update(this.dataByGroup,this.chartSize,this.scaleHelper)},setRangesAndSizes:function(){this.setRanges(),this.setBubbleSizes(),this.addRangePadding(),Object.keys(this.scaleValues).forEach(function(t){this.scaleValues[t]=this.roundToDecimals(this.scaleValues[t])}.bind(this))},setRanges:function(){var e=this.options.chart,a=this.scaleValues,i=this.data,n=e.scale,r=n.x;r?(a.xMax=r.max,a.xMin=e.zeroBaseline.x?0:r.min):(a.xMax=t.max(i,function(t){return t.value[0]}),a.xMin=t.min(i,function(t){return t.value[0]}));var s=n.y;s?(a.yMax=s.max,a.yMin=e.zeroBaseline.y?0:s.min):(a.yMax=t.max(i,function(t){return t.value[1]}),a.yMin=t.min(i,function(t){return t.value[1]}));var l=n.z;l?(a.zMax=l.max,a.zMin=l.min):(a.zMax=t.max(i,function(t){return t.value[2]}),a.zMin=0)},setBubbleSizes:function(){var t=this.chartSize,e=this.scaleValues,a=this.options.plotOptions.bubble,i=a.maxSize,n=a.minSize,r=Math.min(t.height,t.width);i&&(i.toString().indexOf("%")!==-1?(e.bubbleMaxRad=r*(parseFloat(i.split("%")[0])/100),e.bubbleMaxRad=e.bubbleMaxRad/2):e.bubbleMaxRad=parseInt(i)),n&&(n.toString().indexOf("%")!==-1?e.bubbleMinRad=r*(parseFloat(n.split("%")[0])/100):e.bubbleMinRad=parseInt(n))},addRangePadding:function(){var t=this.chartSize,e=this.scaleValues,a=this.options,i=a.plotOptions,n=i.bubble.scalePadding,r=a.chart.scale;if(n.x===!0&&!r.x){var s=Math.abs(e.xMax-e.xMin),l=2*e.bubbleMaxRad*(s/t.width);"time"===i.scaleType.x?(e.xMin=new Date(e.xMin.getTime()-l),e.xMax=new Date(e.xMax.getTime()+l)):(e.xMin-=l,e.xMax+=l)}if(n.y===!0&&!r.y){var h=Math.abs(e.yMax-e.yMin),b=4*e.bubbleMaxRad*(h/t.height);"time"===i.scaleType.y?(e.yMin=new Date(e.yMin.getTime()-b),e.yMax=new Date(e.yMax.getTime()+b)):(e.yMin-=b,e.yMax+=b)}},setScaleHelpers:function(){var e,a,i=this.scaleHelper,n=this.scaleValues,r=this.chartSize,s=this.options,l=s.plotOptions.scaleType,h=l.x,b=l.y,o={left:0,right:0};s.grid!==!1&&(o=this.grid.getOptions().gridPadding),e="time"===h?t.time.scale():t.scale.linear(),a="time"===b?t.time.scale():t.scale.linear(),i.x=e.domain([n.xMin,n.xMax]).range([0,r.width-o.left-o.right]),i.y=a.domain([n.yMin,n.yMax]).range([r.height,0]),i.r=t.scale.sqrt().domain([n.zMin,n.zMax]).range([n.bubbleMinRad,n.bubbleMaxRad])},findLabelInGroup:function(t){var e,a,i,n,r;for(a=0,i=this.dataByGroup.length;a<i;a++)for(e=this.dataByGroup[a].data,n=0,r=e.length;n<r;n++)if(t===e[n].label)return this.dataByGroup[a]},updateExistingElements:function(t){var e=this.options.animation,i=this.scaleHelper;this.bubbleSelection.attr("class","update bubble clickable hoverable datapoint").transition().duration(e.transitionDuration).delay(e.transitionDelay).ease(e.easing).attr("cx",function(t){return i.x(t.value[0])}).attr("cy",function(t){return i.y(t.value[1])}).attr("fill",a.bind(this)).attr("r",function(t){return i.r(t.value[2])})},createElements:function(t){var e=this.scaleHelper;this.bubbleSelection.enter().append("circle").attr("class","enter bubble clickable hoverable datapoint").attr("cx",function(t){return e.x(t.value[0])}).attr("cy",function(t){return e.y(t.value[1])}).attr("fill",a.bind(this)).attr("r",function(t){return e.r(t.value[2])}),this.bubbleSelection.exit().remove()},toggleEntryVisibility:function(t){this.dataIsGrouped?this.dataByGroup.some(function(a){var i=a.label===t.label;return i&&a.data.forEach(e.prototype.toggleEntryVisibility.bind(this)),i}.bind(this)):e.prototype.toggleEntryVisibility.call(this,t)},cleanEventData:function(t){var e={};return Object.defineProperties(e,{label:{value:t.label},value:{value:t.value.slice(0)}}),e}})});