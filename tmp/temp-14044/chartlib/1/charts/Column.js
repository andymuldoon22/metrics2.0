/* Copyright (c) Ericsson 2019 */

define("chartlib/charts/Column",["chartlib/base/d3","chartlib/charts/Chart"],function(t,a){"use strict";function e(t,a){var e=this.options.plotOptions,i="vertical"===e.orientation,r=this.chartSize,n=this.scaleHelper.entries.range(),s=this.getBarValues(t,a,n,this.offsetYVal,r.width,r.height,this.measureData,this.dataDimensions),o=s.x+s.width/2;return e.column.stacked?this.scaleHelper.entries(t.label)+s.x+s.width/2:i?o:o+parseInt(this.svg.style("font-size"))/3}function i(t,a){var e=this.options,i=e.plotOptions;if(i.column.stacked)return this.scaleHelper.values(t.total)-5;var r="vertical"===i.orientation,n=this.chartSize,s=this.scaleHelper.entries.range(),o=this.getBarValues(t,a,s,this.offsetYVal,n.width,n.height,this.measureData,this.dataDimensions);return r&&o.height<0?this.scaleHelper.values(0)-parseInt(this.svg.style("font-size")):!r&&(o.y<0||!e.chart.zeroBaseline&&t.value<0)?this.scaleHelper.values(0)+10:r?o.y-5:o.y+5}function r(t){t.forEach(function(t){t.data.forEach(function(a){a.parentLabel=t.label})})}function n(t){var a=[];t.forEach(function(t){a=a.concat(t.data)});var e={},i=[];return a.forEach(function(t){var a=t.label;e[a]||(i.push(t),e[a]={seen:!0})}),i}return a.extend({defaults:{theme:{plotOptions:{column:{datalabels:{fill:"#58585b"},overlayline:{stroke:"#cccccc",width:3,border:{color:"#ffffff",width:1}},stackedDistance:1}}},plotOptions:{orientation:"vertical",column:{cornerRadius:.1,startAtZero:!0,barWidthScale:.7,grouped:!1,stacked:!1,stackedPercentageComparison:!1,datalabels:!1,overlayLine:!1,overlaySpline:!1},scaleType:{x:"ordinal",y:"linear"}},grid:{tickHint:{}}},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data=[],this.overlayData=[],this.measureData=[],this.overlayType="",this.yMax=0,this.yMin=0,this.overlayYMax=0,this.overlayYMin=0,this.barWrapper=[],this.barWrapperClipPath=[],this.barSelection=[],this.groupSelection=[],this.dataDimensions=2,this.hasOverlay=!1,this.centerPadding=0,this.offsetYVal=0;var t=this.options,a=t.plotOptions.column;a.grouped===!0?a.grouped={groupMarginScale:.75}:a.grouped&&!a.grouped.groupMarginScale&&(a.grouped.groupMarginScale=.75),a&&a.grouped&&a.grouped.compareSets===!0&&(t.grid===!0?t.grid={tickPadding:{x:26}}:t.grid.tickPadding&&(t.grid.tickPadding={x:26}))},redraw:function(){this.createWrapper(),this.update(this.options.data)},createWrapper:function(){0===this.barWrapper.length&&(this.barWrapperClipPath=this.defs.append("clipPath"),this.barWrapperClipPath.attr("id","barWrapperClipPath-"+this.id).append("rect"),this.barWrapper=this.svg.append("g").attr("id","columnWrapper-"+this.id),this.barWrapper.attr("clip-path","url(#barWrapperClipPath-"+this.id+")"))},onUpdate:function(t){this.options.data=t,this.data=this.addIDsToData(t);var a,e=this.overlayData,i=this.options,s=this.chartSize,o=this.barWrapper,l=this.barWrapperClipPath,h=this.barSelection,d=this.groupSelection,c=this.scaleHelper,u=this,p=i.plotOptions,g="vertical"===p.orientation,v=[],f=function(t){return t.visible!==!1};Array.isArray(this.data[0])?v=this.data.map(function(t){return t.filter(f)}):this.data.forEach(function(t){if(t.visible!==!1){var a=t;void 0!==a.data&&(a={label:t.label,data:[]},t.data.forEach(function(t){t.visible!==!1&&a.data.push(t)})),v.push(a)}}),this.data=v;var m=t;m[0]&&m[0].data&&(m=n(m));var y=p.column;y&&y.grouped&&y.grouped.compareSets===!0&&(m=t.map(function(t){return{label:t.label,visible:t.visible}})),(y.overlaySpline||y.overlayLine)&&(this.hasOverlay=!0,this.overlayType=y.overlaySpline?y.overlaySpline:y.overlayLine,"custom"===this.overlayType?(this.overlayData=this.data[1],this.data=this.data[0],v=this.data,m=this.options.data[0]):e=v),this.recalculateDataForPercentageComparison(),this.measureData=[],v[0]&&(this.dataDimensions=v[0].data?3:2,this.measureData=2===this.dataDimensions?v:v[0].data),this.reconfigureDataForStackedCharts(),this.dataDimensions>2&&r(v),this.figureOutTrendLine(e),e=this.overlayData,this.getMaxValues(),this.manageColorDomains();var b=this.getSize(),S=i.chart.margin;s.width=b.width-S.left-S.right,s.height=b.height-S.top-S.bottom,s.margins={left:S.left,top:S.top},s=this.changeSizeForTitle(s),s=this.changeSizeForGrid(s,this.data),this.changeSizeForDataLabels(s,this.data),s=this.changeSizeForLegend(s,m),y.stackedPercentageComparison&&(i.chart.scale={y:{max:100,min:0}}),this.setOrdinalScales();var x=i.grid,D=x!==!1?this.grid.getOptions().gridPadding:{left:0,right:0},M=s.margins;o.attr("transform","translate("+(M.left+D.left)+","+M.top+")");var k={width:s.width+M.left,height:s.height+M.top};if(l.selectAll("rect").attr("x",0).attr("y",-20).attr("width",Math.max(0,k.width)).attr("height",Math.max(0,k.height)),2===this.dataDimensions)h=o.selectAll("path.bar").data(v);else if(3===this.dataDimensions){this.setCenterPadding();var O=this.centerPadding,V=function(t){var e=a(t);return"translate("+e.x+","+e.y+")"};a=function(t){var a=c.entries(t.label)+O;return{x:g?a:0,y:g?0:a}},this.groupSelection=o.selectAll(".group").data(v),d=this.groupSelection;var w=i.animation;d.transition().duration(w.transitionDuration).delay(w.transitionDelay).ease(w.easing).attr("transform",V);var P=d.enter().append("g").attr("class","group").attr("transform",V);d.exit().remove(),y.stacked!==!1&&P.attr("clip-path",function(t,a){return"url(#stackedClip-"+a+"-"+u.id+")"}),h=d.selectAll("path.bar").data(function(t){return t.data})}var C=this.makeDataLabelSelection(),E=this.makeStackedClipPathSelection(),L=g?s.height:s.width;this.offsetYVal=y.startAtZero?c.values(0):L;var z,H=o.selectAll("path.overlayline").data([{data:e}]);if(i.theme.plotOptions.column.overlayline.border&&(z=o.selectAll("path.overlaylineborder").data([{data:e}])),c.line=this.createLineHelper(),this.updateExistingElements(h),this.updateDataLabels(C),this.updateStackedClipPaths(E),this.updateOverlayLine(H,z),this.createNewElements(h),this.createNewDataLabels(C),this.createStackedClipPaths(E),this.createOverlayLine(H,z),h.exit().remove(),C&&C.exit().remove(),x!==!1){var B={x:c.entries,y:c.values},W={position:{y:6}};y.grouped.compareSets===!0&&(W.group={getTickCoords:function(t){var a=y.grouped.groupMarginScale,e=c.groupedEntries.rangeBand(),i=c.groupedEntries(t.label)*a,r=e*y.barWidthScale*a;return{x:g?i+r/2:0,y:g?0:i}},getGroupCoords:a},B.groupedEntries=c.groupedEntries),this.grid.getOptions().tickHint.x=v.length,this.grid.update(v,this.chartSize,B,W)}i.legend!==!1&&this.legend.update(m,this.chartSize,c)},recalculateDataForPercentageComparison:function(){var a=this.data;this.options.plotOptions.column.stackedPercentageComparison&&a.forEach(function(a){var e=0,i=t.sum(a.data,function(t){return t.value});a.data.forEach(function(t){var a=0!==i?t.value/i*100:0;t.originalValue=t.value,t.value=a,t.y0=e,e+=a,t.y1=e}),a.total=100})},reconfigureDataForStackedCharts:function(){if(this.options.plotOptions.column.stacked)if(3===this.dataDimensions)this.data.forEach(function(t){var a=0;t.data.forEach(function(t){t.y0=a,a+=t.value,t.y1=a}),t.total=a});else{var t=0;this.data.forEach(function(a){a.y0=t,a.y1=t+=a.value})}},getMaxValues:function(){var a=this.options,e=a.chart,i=e.scale.y,r=e.zeroBaseline,n=a.plotOptions.column,s=this.data,o=this.dataDimensions,l=this.overlayType,h=this.overlayData,d=function(t){return t.value},c=function(t){return t.total};if(i&&!n.stackedPercentageComparison)this.yMax=i.max,this.yMin=i.min,r.y&&(this.yMin=0);else{var u=n.stacked;if(u&&3===o)this.yMax=t.max(s,c),this.yMin=r?0:t.min(s,function(a){return t.min(a.data.map(d))});else if(u)this.yMax=t.sum(s,d),this.yMin=r?0:t.min(s,d);else if(2===o){var p=s.some(function(t){return t.value>=0});this.yMax=t[p?"max":"min"](s,d),this.yMin=r?0:t[p?"min":"max"](s,d),r||(p?this.yMin>0&&(this.yMin=0):(this.yMin=this.yMax,this.yMax=5))}else 3===o&&(this.yMax=t.max(s,function(a){return t.max(a.data.map(d))}),this.yMin=r?0:t.min(s,function(a){return t.min(a.data.map(d))}));0===this.yMax&&0===this.yMin&&(this.yMax=5),"custom"===l&&(this.overlayYMax=t.max(h,d),this.overlayYMin=t.min(h,d),this.yMax=Math.max(this.yMax,this.overlayYMax),this.yMin=Math.min(this.yMin,this.overlayYMin))}},figureOutTrendLine:function(t){this.hasOverlay===!0&&"trend"===this.overlayType&&(this.overlayData=t.map(function(t){if(t.data){var a=0;return t.data.forEach(function(t){a+=t.value}),{label:t.label,value:a/t.data.length}}return t}))},manageColorDomains:function(){this.firstRun&&Array.isArray(this.options.theme.colors)&&2!==this.dataDimensions&&this.colorScale.domain(this.measureData.map(function(t){return t.label}))},setOrdinalScales:function(){var a=this.options,e=a.plotOptions.column,i=this.data,r=this.scaleHelper,n=this.chartSize,s=i.map(function(t){return t.label}),o=e.stacked&&2===this.dataDimensions?[s[0]]:s,l=[this.yMin,this.yMax],h=a.grid!==!1?this.grid.getOptions().gridPadding:{left:0,right:0},d="vertical"===a.plotOptions.orientation,c=n.width-h.left-h.right,u=n.height,p=d?[0,c]:[0,u],g=d?[u,0]:[0,c];if(this.yMin<0&&this.yMax<0&&(l=l.reverse()),r.entries=t.scale.ordinal().domain(o).rangeRoundBands(p,0),r.values=t.scale.linear().domain(l).range(g).nice(),e.grouped){var v=void 0!==i[0]?i[0].data.map(function(t){return t.label}):[],f=r.entries.rangeBand();r.groupedEntries=t.scale.ordinal().domain(v).rangeRoundBands([0,f])}},createLineHelper:function(){if(this.hasOverlay===!0){var a=this.scaleHelper,e=this.dataDimensions,i=this,r=this.offsetYVal,n=this.chartSize,s=this.measureData,o=a.entries.range(),l=this.options.plotOptions.column;return t.svg.line().interpolate(l.overlaySpline?"cardinal":"linear").x(function(t,h){if(2===e){var d=i.getBarValues(t,h,o,r,n.width,n.height,s,e);return d.x+d.width/2}return l.stacked?a.entries(t.label)+a.entries.rangeBand()/2:a.entries(t.label)+a.entries.rangeBand()/2}).y(function(t){return a.values(t.value)})}},setCenterPadding:function(){var t=this.options.plotOptions.column;if(t.grouped){var a=this.scaleHelper.groupedEntries.rangeBand();this.centerPadding=a*this.measureData.length*(1-t.grouped.groupMarginScale)/2,this.centerPadding+=a*(1-t.barWidthScale)*t.grouped.groupMarginScale/2}},makeDataLabelSelection:function(){var t=this.options.plotOptions.column,a=this.data;if(t.datalabels){var e;return e=2===this.dataDimensions||t.stacked?this.barWrapper.selectAll("text.datalabel").data(a):this.groupSelection.selectAll("text.datalabel").data(function(t){return t.data})}return!1},makeStackedClipPathSelection:function(){var t=this.defs,a=this.data,e=this,i=t.selectAll(".stackedClip").data(a);i.enter().append("clipPath").attr("class","stackedClip").attr("id",function(t,a){return"stackedClip-"+a+"-"+e.id});var r=i.selectAll("path.stackedClipPath").data(function(t,a){return[t]});return r},updateExistingElements:function(t){var a=this.options,e=a.animation,i=this.offsetYVal,r=this.chartSize,n=this.measureData,s=this.dataDimensions,o=this.scaleHelper.entries.range();t.attr("class","update bar clickable hoverable datapoint").transition().duration(e.transitionDuration).delay(e.transitionDelay).ease(e.easing).attr("fill",function(t,e){return a.plotOptions.column.grouped.compareSets===!0?this.colorScale(t.parentLabel,t):this.colorScale(t.label,t)}.bind(this)).attr("d",function(t,a){var e=this.getBarValues(t,a,o,i,r.width,r.height,n,s);return this.roundedRect(e)}.bind(this))},updateDataLabels:function(a){var r=this.options,n=r.plotOptions,s=r.plotOptions.column;if(s.datalabels){var o=r.animation,l="vertical"===n.orientation,h=l?"x":"y",d=l?"y":"x",c=this.getDataLabelFormat();a.attr("class","update datalabel").transition().duration(o.transitionDuration).delay(o.transitionDelay).ease(o.easing).tween("text",function(a){var e=s.stacked?a.total:a.value,i=t.interpolate(this.currentValue,e);return function(t){this.currentValue=i(t),this.textContent=c(this.currentValue)}}).attr(h,e.bind(this)).attr(d,i.bind(this))}},updateStackedClipPaths:function(t){var a=this.scaleHelper,e=this.options.animation,i=this,r=this.offsetYVal,n=this.chartSize,s=this.measureData,o=this.dataDimensions,l=a.entries.range();t.attr("class","update stackedClipPath").transition().duration(e.transitionDuration).delay(e.transitionDelay).ease(e.easing).attr("d",function(t,a,e){var h={value:t.total},d=i.getRegularBarValues(h,a,l,r,n.width,n.height,s,o);return i.roundedRect(d)})},updateOverlayLine:function(t,a){if(this.hasOverlay===!0){var e=this.scaleHelper,i=this.options,r=i.animation;t.attr("class","update overlayline").transition().duration(r.transitionDuration).delay(r.transitionDelay).ease(r.easing).attr("d",function(t,a){return e.line(t.data)}),i.theme.plotOptions.column.overlayline.border&&a.attr("class","update overlaylineborder").transition().duration(r.transitionDuration).delay(r.transitionDelay).ease(r.easing).attr("d",function(t,a){return e.line(t.data)})}},createNewElements:function(t){var a=this.options,e=this.offsetYVal,i=this.chartSize,r=this.measureData,n=this.dataDimensions,s=this,o=this.scaleHelper.entries.range();t.enter().append("path").attr("class","enter bar clickable hoverable datapoint").attr("stroke","none").attr("fill",function(t,e){return a.plotOptions.column.grouped.compareSets===!0?s.colorScale(t.parentLabel,t):s.colorScale(t.label,t)}).attr("d",function(t,a,l){var h=s.getBarValues(t,a,o,e,i.width,i.height,r,n);return s.roundedRect(h)}),t.exit().remove()},createNewDataLabels:function(t){var a=this.options,r=a.plotOptions;if(r.column.datalabels){var n="vertical"===r.orientation,s=n?"x":"y",o=n?"y":"x",l=this.getDataLabelFormat();t.enter().append("text").attr("class","enter datalabel").attr("text-anchor",n?"middle":"left").attr("fill",a.theme.plotOptions.column.datalabels.fill).attr(s,e.bind(this)).attr(o,i.bind(this)).text(function(t){return this.currentValue=r.column.stacked?t.total:t.value,l(this.currentValue)}),t.exit().remove()}},createStackedClipPaths:function(t){if(this.options.plotOptions.column.stacked){var a=this.scaleHelper,e=this.offsetYVal,i=this.chartSize,r=this,n=this.measureData,s=this.dataDimensions,o=a.entries.range();t.enter().append("path").attr("class","enter stackedClipPath").attr("d",function(t,a,l){var h={value:t.total},d=r.getRegularBarValues(h,a,o,e,i.width,i.height,n,s);return r.roundedRect(d)}),t.exit().remove()}},createOverlayLine:function(t,a){if(this.hasOverlay===!0){var e=this.scaleHelper,i=this.options.theme.plotOptions.column.overlayline,r=i.border;r&&(a.enter().append("path").attr("class","enter overlaylineborder").attr("fill","none").attr("d",function(t,a){return e.line(t.data)}).attr("stroke",r.color).attr("stroke-linecap","round").attr("stroke-width",i.width+2*r.width),a.exit().remove()),t.enter().append("path").attr("class","enter overlayline").attr("fill","none").attr("d",function(t,a){return e.line(t.data)}).attr("stroke",i.stroke).attr("stroke-linecap","round").attr("stroke-width",i.width),t.exit().remove()}},getBarValues:function(t,a,e,i,r,n,s,o){var l=this.options.plotOptions.column;return l.stacked?this.getStackedBarValues(t,a,e,i,r,n,s,o):l.grouped?this.getGroupedBarValues(t,a,e,i,r,n,s,o):this.getRegularBarValues(t,a,e,i,r,n,s,o)},getRegularBarValues:function(t,a,e,i,r,n,s,o){var l=this.options.plotOptions.column,h=l.barWidthScale,d=this.scaleHelper.entries.rangeBand(),c={x:e[a]+(d-d*h)/2,y:this.scaleHelper.values(t.value),width:d*h,height:n-this.scaleHelper.values(t.value)-(n-i),radius:d*h*l.cornerRadius};return c.radius>Math.abs(c.height)&&(c.radius=Math.abs(c.height)),c},getGroupedBarValues:function(t,a,e,i,r,n,s,o){var l=this.options.plotOptions.column,h=this.scaleHelper.groupedEntries.rangeBand(),d=l.grouped.groupMarginScale,c=l.barWidthScale,u={x:this.scaleHelper.groupedEntries(t.label)*d,y:this.scaleHelper.values(t.value),width:h*c*d,height:n-this.scaleHelper.values(t.value)-(n-i),radius:h*c*d*l.cornerRadius};return u.radius>Math.abs(u.height)&&(u.radius=Math.abs(u.height)),u},getStackedBarValues:function(t,a,e,i,r,n,s,o){var l=this.scaleHelper,h=this.options,d=l.entries.rangeBand(),c=h.plotOptions.column.barWidthScale,u={x:e[0]+(d-d*c)/2,y:l.values(t.y1),width:d*c,height:l.values(t.y0)-l.values(t.y1),radius:0},p=h.theme.plotOptions.column.stackedDistance;return 0!==a&&p&&(u.height-=p),u},roundedRect:function(t){var a="vertical"===this.options.plotOptions.orientation,e=t.x,i=t.y,r=t.radius,n=t.radius,s=t.height,o=t.width,l="",h="",d="";return a?(s<0?(r=0,s*=-1,i-=s):n=0,h="a"+n+","+n+" 0 0 1 ",d="a"+r+","+r+" 0 0 1 ",l+="M"+e+","+(i+r),l+=d+r+","+(0-r),l+="h"+(o-2*r),l+=d+r+","+r,l+="v"+(s-(r+n)),l+=h+(0-n)+","+n,l+="h"+(0-(o-2*n)),l+=h+(0-n)+","+(0-n)):(s<0?(s*=-1,i-=s,n=0):r=0,h="a"+n+","+n+" 0 0 1 ",d="a"+r+","+r+" 0 0 1 ",l+="M"+i+","+(e+n),l+=h+n+","+(0-n),l+="h"+(s-(r+n)),l+=d+r+","+r,l+="v"+(o-2*r),l+=d+(0-r)+","+r,l+="h"+(0-(s-(r+n))),l+=h+(0-n)+","+(0-n)),l+="z"},toggleEntryVisibility:function(t){var e=function(i){return Array.isArray(i)?void i.forEach(e):(i.label==t.label&&a.prototype.toggleEntryVisibility.call(this,i),void(void 0!==i.data&&i.data.forEach(e.bind(this))))}.bind(this);3===this.dataDimensions?this.options.data.forEach(e):a.prototype.toggleEntryVisibility.call(this,t)},changeSizeForDataLabels:function(t,a){var e,i,r,n=this.options,s=n.plotOptions,o=0;s.column.datalabels&&"horizontal"===s.orientation&&(e=this.getLongestStringFromData("value",a)||"0",i=this.localizeValueString(e),o+=Math.round(this.measureTextFieldSize(i).width),n.chart.zeroBaseline===!1&&this.yMin<0&&(r=Math.round(this.measureTextFieldSize(this.localizeValueString(this.yMin)).width),this.grid||(t.margins.left+=r),o+=r),t.width-=o)},cleanEventData:function(t){var a={};return Object.defineProperties(a,{label:{value:t.label},value:{value:t.value}}),void 0!==t.parentLabel&&Object.defineProperty(a,"parentLabel",{value:t.parentLabel}),void 0!==t.originalValue&&Object.defineProperty(a,"originalValue",{value:t.originalValue}),a}})});