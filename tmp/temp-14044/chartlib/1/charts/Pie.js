/* Copyright (c) Ericsson 2019 */

define("chartlib/charts/Pie",["chartlib/base/d3","chartlib/charts/Chart"],function(t,i){"use strict";function e(t){return this.isGradientFill?"url(#piegradientfill-"+this.id+")":this.colorScale(t.data.label,t)}function n(t){var i=this.options.animation,n=this;t.selection.enter().append("path").attr("opacity",t.opacity).attr("class","arc clickable hoverable datapoint").each(function(i){isNaN(i.startAngle)&&(i.startAngle=0),isNaN(i.endAngle)&&(i.endAngle=0),this._current=i,i.arcHelper=t.arcHelper}).attr("d",function(i,e,a){return t.arcHelper(i,e,a,this,n)}).attr("fill",e.bind(this)).transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attrTween("d",function(t,i,e){return r(t,i,e,this,n)}),t.selection.exit().remove()}function a(t){var i=this.options.animation,n=this;t.selection.each(function(i){isNaN(i.startAngle)&&(i.startAngle=0),isNaN(i.endAngle)&&(i.endAngle=0),i.arcHelper=t.arcHelper}).transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attr("fill",e.bind(this)).attrTween("d",function(t,i,e){return r(t,i,e,this,n)})}function r(i,e,n,a,r){isNaN(a._current.endAngle)&&(a._current.endAngle=0,a._current.startAngle=0,i.endAngle=0,i.startAngle=0);var s=t.interpolate(a._current,i);return a._current=s(0),function(t){return i.arcHelper(s(t),e,n,a,r)}}function s(t){t.forEach(function(t){t.data.forEach(function(i){i.parentLabel=t.label})})}function o(i,e){var n=t.select(this);n.text("");var a=e.data.label;if(a.length>10)if(a.indexOf(" ")!==-1){var r=a.split(" ");n.append("tspan").text(r[0]).attr("y",-(1.1*i.calloutLegendFontSize)),n.append("tspan").text(r[1]+"...").attr("x",0).attr("y",0)}else n.text(a.substr(0,9)+"...");else n.text(a)}return i.extend({defaults:{theme:{plotOptions:{pie:{stroke:{color:"#ffffff",width:1},fill:!1,comparisonCallouts:{radius:3,strokeWidth:1,fill:"lightgrey"}}}},plotOptions:{pie:{radius:!1,innerRadius:!1}},legend:!1,grid:!1},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.pieLayers=[],this.radius=0,this.innerRadius=0,this.data=[],this.pieWrapper=[],this.gradientFill=[],this.calloutLegendFontSize=12,this.calloutLegendWrapper=null,this.dataDimensions=2,this.baseTextDistance=20,this.divingLinesStyle={color:"#ffffff",width:1},this.isGradientFill=!1,this.useCoreLegend=!0,this.useCallouts=!1,this.arcHelpers={}},redraw:function(){var t=this.options;this.isGradientFill=t.theme.plotOptions.pie.fill!==!1,this.isGradientFill!==!1&&(this.useCoreLegend=!1),this.createGradientFill(),this.createWrapper(),this.update(t.data)},createWrapper:function(){0===this.pieWrapper.length&&(this.pieWrapper=this.svg.append("g").attr("id","pieWrapper-"+this.id))},createGradientFill:function(){if(this.isGradientFill===!0&&0===this.gradientFill.length){this.gradientFill=this.defs.append("linearGradient").attr("id","piegradientfill-"+this.id).attr("gradientUnits","userSpaceOnUse");var t=this.options.theme.plotOptions.pie.fill,i=t;t.stops&&(i=t.stops[0]);var e=t;t.stops&&(e=t.stops[1]),this.gradientFill.append("stop").attr("offset","0").attr("stop-opacity","1").attr("stop-color",i),this.gradientFill.append("stop").attr("offset","1").attr("stop-opacity","1").attr("stop-color",e)}},updateGradientFill:function(){var t=this.radius;this.isGradientFill===!0&&this.gradientFill.attr("x1",-(t/2)).attr("y1",-(t/2)).attr("x2",t/2).attr("y2",t/2)},onUpdate:function(t){this.options.data=t,this.data=this.addIDsToData(t).filter(function(t){return t.visible!==!1});var i=this.options,e=this.chartSize,r=this.arcHelpers,o=this.data,l=t;l[0].data&&(l=l[0].data),o[0]&&(this.dataDimensions=o[0].data?3:2),this.dataDimensions>2&&s(o);var u=this.getSize(),d=i.chart.margin;e.width=u.width-d.left-d.right,e.height=u.height-d.top-d.bottom,e.margins={left:d.left,top:d.top},e=this.changeSizeForTitle(e),this.useCoreLegend===!0&&(e=this.changeSizeForLegend(e,l)),this.figureOutRadius(),this.updateGradientFill(),this.createArcHelpers(),this.createAndPopulatePieLayers(),this.pieLayers.forEach(function(t){t.selection=t.wrapper.selectAll(".arc").data(r.pie(t.data)),a.call(this,t),n.call(this,t)}.bind(this));var c=i.legend;if(this.useCallouts===!0){c===!1||"callouts"!==c.align&&this.isGradientFill===!1||this.calloutLegendWrapper||(this.calloutLegendWrapper=this.pieWrapper.append("g"));var h=2===this.dataDimensions?this.arcHelpers.pie(o):this.manipulateDataForMultidimensionalCalloutLegend(o),p=this.calloutLegendWrapper.selectAll("text").data(h);if(this.updateCallouts(p),this.createNewCallouts(p),3===this.dataDimensions){var g=this.calloutLegendWrapper.selectAll(".comparisonLine").data(this.figureOutComparisonLinesData(h));this.updateComparisonLines(g),this.createComparisonLines(g);var f=this.createComparisonDotSelection(o);this.updateComparisonDots(f),this.createComparisonDots(f)}}if(this.isGradientFill===!0||i.theme.plotOptions.pie.stroke!==!1){var v=this.createDividingLinesSelection(o);this.updateDividingLines(v),this.createDividingLines(v)}this.positionPie(),c!==!1&&this.useCallouts!==!0&&this.legend.update(t,this.chartSize,this.scaleHelper)},figureOutRadius:function(){var t=this.options,i=this.chartSize,e=!1,n=!1,a=t.plotOptions,r=t.legend,s=a.pie;if(a&&s&&(s.radius&&(this.radius=s.radius,this.innerRadius=.6*this.radius,e=!0,"callouts"!==r.align&&this.isGradientFill!==!0||(this.useCallouts=!0)),(s.innerRadius||0===s.innerRadius)&&(this.innerRadius=s.innerRadius,n=!0)),e===!1){var o=i.height<i.width?i.height:i.width;this.radius=o/2,r&&("callouts"!==r.align&&this.isGradientFill!==!0||(this.useCallouts=!0,o-=2.5*(this.calloutLegendFontSize+this.baseTextDistance),this.radius=o/2))}n===!1&&(this.innerRadius=0,3===this.dataDimensions&&(this.innerRadius=.5*this.radius)),e===!1&&n===!0&&(this.innerRadius=this.radius*s.innerRadius)},createArcHelpers:function(){var i=this.arcHelpers,e=this.radius,n=this.innerRadius;i.arc=t.svg.arc().outerRadius(e).innerRadius(n),i.calloutArc=this.calloutArcFunction,i.pie=t.layout.pie().sort(null).value(function(t){return t.value})},createAndPopulatePieLayers:function(){for(var t=this.radius,i=this.innerRadius,e=this.pieLayers,n=this.data,a=this.PieLayer,r=this.dataDimensions,s=3===r?n.length:1,o=(t-i)/(s+1),l=0;l<s;l++){var u,d,c,h=3===r?n[l].data:n;3===r?(u=t-l*o,d=t-(l+1)*o,l===s-1&&(d-=o),c=1-.2*(s-1-l)):(u=t,d=i,c=1),e[l]?(e[l].radius=u,e[l].innerRadius=d,e[l].data=h,e[l].updateArcHelper()):e[l]=new a(h,{radius:u,innerRadius:d,opacity:c},this)}},positionPie:function(){var t=this.chartSize,i=t.margins,e=i.left+t.width/2,n=i.top+t.height/2;this.pieWrapper.attr("transform","translate("+e+","+n+")")},calloutArcFunction:function(t,i,e,n,a){var r=a.radius,s=a.arcHelpers,o=s.arc.apply(n,arguments),l=t,u=(l.startAngle+l.endAngle)/2,d=.08,c=Math.max(l.startAngle,l.endAngle),h=Math.min(l.startAngle,l.endAngle),p=c-h,g={y:Math.cos(u-d/2)*r,x:Math.sin(u-d/2)*r},f={y:Math.cos(u+d/2)*r,x:Math.sin(u+d/2)*r},v=a.measurePointDistance(g,f),A={y:Math.cos(u)*(r+v),x:Math.sin(u)*(r+v)};return p>d&&(o+=" M "+g.x+","+g.y*-1+" L "+A.x+","+A.y*-1+" L "+f.x+","+f.y*-1),o},measurePointDistance:function(t,i){var e=t.x-i.x,n=t.y-i.y,a=Math.pow(e,2)+Math.pow(n,2),r=Math.sqrt(a);return r},updateCallouts:function(t){var i=this.options.animation,e=this;t.each(function(t){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0),o.call(this,e,t)}).transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attrTween("transform",function(t){return e.calloutLegendTween(t,this)})},createNewCallouts:function(t){var i=this.options,e=this,n=this.calloutLegendFontSize,a=i.animation;t.enter().append("text").each(function(t){o.call(this,e,t)}).attr("font-size",n).attr("transform",function(t,i,n){return e.calloutLegendTranslate(t,i,n,e)}).attr("fill",i.theme.legend.text.fill).each(function(t){this.text=this,this._current=t}).transition().duration(a.transitionDuration).delay(a.transitionDelay).ease(a.easing).attrTween("transform",function(t){return e.calloutLegendTween(t,this)}),t.exit().remove()},calloutLegendTween:function(i,e){var n=this;isNaN(e._current.endAngle)&&(e._current.endAngle=0,e._current.startAngle=0,i.endAngle=0,i.startAngle=0);var a=t.interpolate(e._current,i);e._current=a(0);var r=e.text;return function(t){return n.calloutLegendTranslate(a(t),0,0,n,r)}},calloutLegendTranslate:function(i,e,n,a,r){r=r||this;var s=a.radius,o=a.baseTextDistance,l=a.options,u=1.2,d=o*u;isNaN(i.startAngle)&&(i.startAngle=0),isNaN(i.endAngle)&&(i.endAngle=0);var c=i.startAngle,h=i.endAngle,p=(c+h)/2,g=Math.sin(p),f=Math.cos(p),v=f*(s+d)*-1,A=g*(s+d),m=!1;try{r.getBBox()}catch(t){m=!0}if(m===!0)return"translate("+A+","+v+")";var L=r.getBBox().width/2,y=r.getBBox().height/2;A-=L+g*-1*L,v+=y+f*-1*y;var D=Math.max(i.startAngle,i.endAngle),x=Math.min(i.startAngle,i.endAngle),w=D-x;return(w<.2&&r.getBBox().width>24||w<.05)&&!l.plotOptions.pie.isComparative?t.select(r).style("visibility","hidden"):t.select(r).style("visibility",null),"translate("+A+","+v+")"},manipulateDataForMultidimensionalCalloutLegend:function(t){var i=this,e=t.slice();return e=e.map(function(t){return i.arcHelpers.pie(t.data)}),e[0].forEach(function(i,n){var a=0,r=0;e.forEach(function(t,i){a+=t[n].startAngle,r+=t[n].endAngle}),a/=t.length,r/=t.length,i.startAngle=a,i.endAngle=r,i.i=n}),e[0]},figureOutComparisonLinesData:function(t){var i=this.data,e=this.arcHelpers,n=i.map(function(t){return e.pie(t.data)});return t=t.map(function(t,i){return t.data=[],n.forEach(function(e,n){t.data.push(e[i])}),t})},comparisonLineResult:function(t,i){var e=i.radius,n=i.baseTextDistance,a=(i.distanceScale,i.pieLayers),r=t.startAngle,s=t.endAngle,o=(r+s)/2,l=Math.sin(o),u=Math.cos(o),d=u*(e+n)*-1,c=l*(e+n),h="";return t.data.forEach(function(t,e){var n=a[e],r=n.radius-(n.radius-n.innerRadius)/2,s=i.getCalcPos(t,r);h+=" M"+c+","+d,h+=" L"+s.x+","+s.y}),h},getCalcPos:function(t,i){var e=(t.startAngle+t.endAngle)/2,n={x:Math.sin(e)*i,y:Math.cos(e)*i*-1};return n},comparisonLineTween:function(i,e){var n=this,a=t.interpolate(e._current,i);return e._current=a(0),function(t){return n.comparisonLineResult(a(t),n)}},updateComparisonLines:function(t){var i=this.options.animation,e=this;t.attr("class","comparisonLine update").transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attrTween("d",function(t){return e.comparisonLineTween(t,this)})},createComparisonLines:function(t){var i=this.options.theme.plotOptions.pie.comparisonCallouts,e=this;t.enter().append("path").style("stroke-width",i.strokeWidth).attr("fill","transparent").attr("stroke",i.fill).attr("class","comparisonLine enter").each(function(t){this._current=t}).attr("d",function(t,i,n){return e.comparisonLineResult(t,e)}),t.exit().remove()},createComparisonDotSelection:function(t){var i=this,e=this.calloutLegendWrapper.selectAll(".comparisonDotGroup").data(t);return e.enter().append("g").attr("class","comparisonDotGroup"),e.exit().remove(),e.selectAll(".comparisonDot").data(function(t,e){return i.arcHelpers.pie(t.data)})},updateComparisonDots:function(t){var i=this.options.animation,e=this;t.each(function(t,i,e){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0)}).transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attrTween("transform",function(t){return e.comparisonDotTween(t,this)})},createComparisonDots:function(t){var i=this.options,e=this,n=i.animation,a=i.theme.plotOptions.pie.comparisonCallouts;t.enter().append("circle").attr("class","comparisonDot").attr("fill",a.fill).attr("r",a.radius).each(function(t,i,e){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0),t.group=e,this._current=t}).attr("transform",function(t){return e.comparisonDotPosition(t,e)}).transition().duration(n.transitionDuration).delay(n.transitionDelay).ease(n.easing).attrTween("transform",function(t){return e.comparisonDotTween(t,this)}),t.exit().remove()},comparisonDotTween:function(i,e){var n=this;isNaN(e._current.endAngle)&&(e._current.endAngle=0,e._current.startAngle=0,i.endAngle=0,i.startAngle=0);var a=t.interpolate(e._current,i);return e._current=a(0),function(t){return n.comparisonDotPosition(a(t),n)}},comparisonDotPosition:function(t,i){var e=i.pieLayers[t.group],n=e.radius-(e.radius-e.innerRadius)/2,a=(t.startAngle+t.endAngle)/2,r={x:Math.sin(a)*n,y:Math.cos(a)*n*-1};return"translate("+r.x+","+r.y+")"},createDividingLinesSelection:function(t){var i=this.arcHelpers;this.pieWrapper.append("g");var e=2===this.dataDimensions?[t]:t,n=this.pieWrapper.selectAll(".dividingLineGroup").data(e);return n.enter().append("g").attr("class","dividingLineGroup"),n.exit().remove(),n.selectAll(".dividingLine").data(function(t,e){return t.data?i.pie(t.data):i.pie(t)})},updateDividingLines:function(t){var i=this.options.animation,e=this;t.each(function(t){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0)}).transition().duration(i.transitionDuration).delay(i.transitionDelay).ease(i.easing).attrTween("d",function(t,i,n){return e.dividingLineTween(t,i,n,this,e)})},createDividingLines:function(t){var i=this.options.theme.plotOptions.pie.stroke,e=this.divingLinesStyle,n=this;i!==!1&&((i.width||0===i.width)&&(e.width=i.width),i.color&&(e.color=i.color)),t.enter().append("path").each(function(t,i,e){t.group=e,this._current=t}).style("stroke-width",e.width).attr("class","dividingLine").attr("stroke",e.color).attr("d",function(t,i,e){return n.dividingLineResult(t,i,e,this,n)}),t.exit().remove()},dividingLineResult:function(t,i,e,n,a){var r=a.pieLayers[t.group];isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0);var s=Math.sin(t.startAngle)*r.innerRadius,o=Math.cos(t.startAngle)*r.innerRadius*-1,l=Math.sin(t.startAngle)*r.radius,u=Math.cos(t.startAngle)*r.radius*-1,d=" M"+s+","+o+" L"+s+","+o+" L"+l+","+u;return d},dividingLineTween:function(i,e,n,a,r){isNaN(a._current.endAngle)&&(a._current.endAngle=0,a._current.startAngle=0,i.endAngle=0,i.startAngle=0);var s=t.interpolate(a._current,i);return a._current=s(0),function(t){return r.dividingLineResult(s(t),e,n,a,r)}},PieLayer:function(i,e,n){e||(e={}),e=n.objectMerger({radius:n.radius,innerRadius:n.innerRadius,opacity:1},e),this.opacity=e.opacity,this.data=i,this.radius=e.radius,this.innerRadius=e.innerRadius,this.wrapper=n.pieWrapper.append("g"),this.updateArcHelper=function(){n.useCallouts===!0&&2===n.dataDimensions?this.arcHelper=n.arcHelpers.calloutArc:this.arcHelper=t.svg.arc().outerRadius(this.radius).innerRadius(this.innerRadius)},this.updateArcHelper()},cleanEventData:function(t){var i={};return Object.defineProperties(i,{label:{value:t.data.label},value:{value:t.data.value}}),void 0!==t.data.parentLabel&&Object.defineProperty(i,"parentLabel",{value:t.data.parentLabel}),i}})});