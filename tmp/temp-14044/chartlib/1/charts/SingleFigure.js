/* Copyright (c) Ericsson 2019 */

define("chartlib/charts/SingleFigure",["chartlib/base/d3","chartlib/charts/Chart"],function(t,i){"use strict";return i.extend({defaults:{theme:{title:{fontSize:38},subTitle:{fontSize:20},plotOptions:{pictorial:{number:{fontWeight:"normal",fontFamily:"Ericsson Capital, Arial",fontSize:"100",fill:"#58585b",unit:"%"},descriptive:{fontFamily:"Arial",fontWeight:"normal",fontSize:13,fill:"#58585b"}}}},plotOptions:{pictorial:{descriptive:!1}},chart:{margin:"useSpecialMargins"},grid:!1},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data=[],this.singleFigureWrapper=[],this.figureWrapper=[],this.numberWrapper=[],this.labelWrapper=[],this.figureSize={},this.numberSize={},this.availableSpace={},this.figures=[],this.isSingleValue=!0,this.topCut=[],this.bottomCut=[],this.useSpecialMargins="useSpecialMargins"===this.options.chart.margin},redraw:function(){if(this.createWrapper(),this.useSpecialMargins===!0){var t=this.getSize();t=.0476*t.width,this.options.chart.margin={top:t,bottom:t,left:0,right:0}}this.update(this.options.data)},createWrapper:function(){0===this.singleFigureWrapper.length&&(this.singleFigureWrapper=this.svg.append("g").attr("id","singleFigureWrapper-"+this.id),this.figureWrapper=this.singleFigureWrapper.append("g").attr("id","figureWrapper-"+this.id),this.numberWrapper=this.singleFigureWrapper.append("g").attr("id","numberWrapper-"+this.id),this.labelWrapper=this.singleFigureWrapper.append("g").attr("id","labelWrapper-"+this.id))},onUpdate:function(t){this.options.data=t;var i=this.chartSize;this.data=t;var e=this.data,a=this.options,r=this.getSize(),n=a.chart.margin;i.width=r.width-n.left-n.right,i.height=r.height-n.top-n.bottom,i.margins={left:n.left,top:n.top},i=this.changeSizeForTitle(i),this.positionWrapper(),this.setAreaSizes(),this.createCutSizes(),this.figureSize=this.measureFigurePath(a.path),this.createFigure();var s=a.plotOptions.pictorial.descriptive;if(s!==!1){var h=this.labelWrapper.selectAll(".label").data([{value:0,label:s.text}]);this.updateLabelText(h),this.createLabelText(h)}var l,p=a.theme.plotOptions.pictorial.number,o=a.chart.scale.y;if(o){var u=Math.max(e[0].value,o);l=this.roundToDecimals(u)+p.unit}else l=this.roundToDecimals(e[0].value)+p.unit;this.maxY=void 0!==o?o:100,this.numberSize=this.measureTextFieldSize(l,p.fontSize,p.fontFamily);var c=this.numberWrapper.selectAll(".label").data(e);this.updateNumber(c),this.createNumber(c),this.moveAndScaleFigure(),this.moveAndScaleNumber(),this.moveAndScaleCuts(),this.moveLabelText()},positionWrapper:function(){var t=this.chartSize.margins;this.singleFigureWrapper.attr("transform","translate("+t.left+", "+t.top+")")},measureFigurePath:function(t){var i=this.svg.append("path").attr("d",t),e=i.node().getBBox();return i.remove(),e},setAreaSizes:function(){var t=this.chartSize.width,i={marginleft:.0476,figure:.4286,gap:.0476,label:.4286,number:.2636,marginright:.0476};i.marginleft=i.marginleft*t,i.figure=i.figure*t,i.gap=i.gap*t,i.number=i.number*t,i.label=i.label*t,i.marginright=i.marginright*t,this.availableSpace=i},createCutSizes:function(){0===this.topCut.length&&(this.topCut=this.defs.append("clipPath").attr("id","addOfPercentage-"+this.id).append("rect"),this.bottomCut=this.defs.append("clipPath").attr("id","cutOfPercentage-"+this.id).append("rect"))},createFigure:function(){var t=this.data.map(function(t){return{label:t.label,value:parseFloat(t.value)}}),i=this.colorScale,e=this.options,a=e.theme.colors,r=e.animation,n=Array.isArray(a)?a[0]:i(t[0]);0===this.figures.length&&(this.figures[0]=this.figureWrapper.append("path").attr("clip-path","url(#cutOfPercentage-"+this.id+")").attr("d",e.path).attr("fill",n),this.figures[1]=this.figureWrapper.append("path").attr("clip-path","url(#addOfPercentage-"+this.id+")").attr("d",e.path).attr("fill-opacity",.3).attr("fill",n)),this.figureWrapper.selectAll("path").transition().duration(r.transitionDuration).delay(r.transitionDelay).ease(r.easing).attr("fill",n)},updateLabelText:function(t){var i=this;t.attr("class","update label").text("").each(function(t){i.wrapLabelText(t,this,i)})},createLabelText:function(t){var i=this,e=this.options.theme.plotOptions.pictorial.descriptive;t.enter().append("text").attr("class","enter label").attr("font-weight",e.fontWeight).attr("font-size",e.fontSize).attr("font-family",e.fontFamily).attr("fill",e.fill).attr("dy",".71em").each(function(t){i.wrapLabelText(t,this,i)})},wrapLabelText:function(i,e,a){var r=a.availableSpace,n=r.marginleft+r.figure+r.gap,s=r.label,h="1.2";a.wrapTextField(t.select(e),i.label,n,s,h)},updateNumber:function(i){var e=this.options,a=this,r=e.animation,n=e.theme.plotOptions.pictorial.number.unit;i.attr("class","update label").transition().duration(r.transitionDuration).delay(r.transitionDelay).ease(r.easing).tween("text",function(i){var e=t.interpolate(this.textContent.replace(n,"").replace(",","."),a.roundToDecimals(i.value).replace(",","."));return this.textContent=e(0),function(t){this.textContent=a.roundToDecimals(e(t))+n}})},createNumber:function(t){var i=this.options,e=this,a=i.theme.plotOptions.pictorial.number;t.enter().append("text").attr("class","enter label").attr("font-family",a.fontFamily).attr("font-size",a.fontSize).attr("fill",a.fill).attr("dy","0.9em").text(function(t){return e.roundToDecimals(t.value)+a.unit})},moveAndScaleFigure:function(){var t=this.availableSpace,i=this.figureSize,e=this.chartSize.height,a=t.figure/i.width,r=e/i.height,n=Math.min(a,r),s=i.width*n;s=t.figure-s+t.marginleft;var h=i.height*n;h=(e-h)/2,this.figureWrapper.attr("transform","matrix("+n+", 0, 0, "+n+", "+s+", "+h+")")},moveAndScaleNumber:function(){var t=this.availableSpace,i=this.numberSize,e=this.chartSize.height,a=t.number/i.width,r=e/i.height,n=Math.min(a,r),s=i.width*n;s=t.number-s+t.marginleft+t.gap+t.figure;var h=i.height*n;this.options.plotOptions.pictorial.descriptive!==!1&&(h+=this.labelWrapper.node().getBBox().height+10),h=(e-h)/2,this.numberWrapper.attr("transform","matrix("+n+", 0, 0, "+n+", "+s+", "+h+")"),this.numberWrapScale=n},moveAndScaleCuts:function(){var t=this.options.animation,i=this.figureSize,e=1-this.data[0].value/this.maxY;e<0&&(e=0),this.topCut.transition().duration(t.transitionDuration).delay(t.transitionDelay).ease(t.easing).attr("x",0).attr("y",0).attr("height",Math.max(0,i.height*e)).attr("width",Math.max(0,i.width)),this.bottomCut.transition().duration(t.transitionDuration).delay(t.transitionDelay).ease(t.easing).attr("x",0).attr("y",i.height*e).attr("height",Math.max(0,i.height*(1-e))).attr("width",Math.max(0,i.width))},moveLabelText:function(){var t=this.options.plotOptions.pictorial.descriptive;if(t!==!1){var i=this.numberSize.height*this.numberWrapScale;t!==!1&&(i+=this.labelWrapper.node().getBBox().height+10),i=(this.chartSize.height-i)/2,i+=this.numberSize.height*this.numberWrapScale,i-=this.numberSize.height*this.numberWrapScale*.2,i+=10,this.labelWrapper.attr("transform","translate(0,"+i+")")}}})});